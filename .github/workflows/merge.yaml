name: Merge PR
on:
  pull_request:
    types:
      - closed
      # - synchronize
    branches:
      - main
concurrency:
  group: merge
  cancel-in-progress: false
jobs:
  delete-artifacts:
    name: Delete artifacts
    runs-on: ubuntu-24.04
    if: github.event.pull_request.merged == true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      - name: Setup GCP
        id: gcp
        uses: hoprnet/hopr-workflows/actions/setup-gcp@master
        with:
          google-credentials: ${{ secrets.GCP_SA_GITHUB_ACTIONS }}
          install-sdk: "true"
      - name: Delete artifacts
        run: |
          set -x
          pr_version=$(grep -E '^version\s*=' src-tauri/Cargo.toml | awk -F\" '{print $2}')-pr.${{ github.event.pull_request.number }}
          echo "pr_version=$pr_version" | tee -a $GITHUB_OUTPUT
          gcloud config set artifacts/location europe-west3
          gcloud artifacts versions delete --quiet --repository="rust-binaries" --package=gnosis_vpn-app ${pr_version}  2> /dev/null || true
  build-binaries:
    strategy:
      matrix:
        binary:
          - architecture: universal-darwin
          - architecture: aarch64-darwin
          - architecture: x86_64-darwin
    name: Binary ${{ matrix.binary.architecture }}
    needs:
      - delete-artifacts
    uses: ./.github/workflows/build-binaries.yaml
    with:
      branch: ${{ github.event.pull_request.base.ref }}
      architecture: ${{ matrix.binary.architecture }}
      version_type: "pr"
    secrets: inherit
